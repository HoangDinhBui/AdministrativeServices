@{
    ViewData["Title"] = "Đăng ký tạm trú";
}

<div class="max-width-900 mx-auto">
    <div class="mb-4">
        <h2 class="fw-bold">Đăng ký tạm trú</h2>
        <p class="text-muted">Đăng ký tạm trú cho công dân. Hệ thống sẽ gửi xác nhận tới chủ nhà nếu có tài khoản.</p>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Create" method="post" enctype="multipart/form-data" id="tempResidenceForm">
        <input type="hidden" name="serviceTypeId" value="@ViewBag.ServiceId" />

        <!-- Registration Type -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">1. Loại hình đăng ký</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="registrationType" value="New" id="typeNew" checked />
                        <label class="form-check-label" for="typeNew">Đăng ký mới</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="registrationType" value="Extend" id="typeExtend" />
                        <label class="form-check-label" for="typeExtend">Gia hạn tạm trú</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="registrationType" value="Update" id="typeUpdate" />
                        <label class="form-check-label" for="typeUpdate">Thay đổi thông tin</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applicant Info -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">2. Thông tin người đăng ký</h5>
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Họ và tên</label>
                    <input name="applicantName" class="form-control" value="@ViewBag.ApplicantName" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Số CCCD</label>
                    <input name="applicantCCCD" id="applicantCCCD" class="form-control" value="@ViewBag.ApplicantCCCD" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Số điện thoại</label>
                    <input name="applicantPhone" type="tel" class="form-control" placeholder="0912345678" required />
                </div>
            </div>
            
            <button type="button" class="btn btn-info btn-sm mt-3" onclick="verifyEligibility()">
                <i class="bi bi-shield-check"></i> Kiểm tra điều kiện tạm trú
            </button>
            <div id="verificationResults" class="mt-3" style="display:none;"></div>
        </div>

        <!-- Address -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">3. Địa chỉ tạm trú</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Tỉnh/Thành phố</label>
                    <input name="province" class="form-control" placeholder="Hà Nội" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quận/Huyện</label>
                    <input name="district" class="form-control" placeholder="Cầu Giấy" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Phường/Xã</label>
                    <input name="ward" class="form-control" placeholder="Dịch Vọng" required />
                </div>
                <div class="col-12">
                    <label class="form-label">Số nhà, Thôn/Xóm</label>
                    <input name="addressDetail" class="form-control" placeholder="Số 15, Ngõ 25, Đường ABC" required />
                </div>
            </div>
        </div>

        <!-- Duration -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">4. Thời hạn tạm trú</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Từ ngày</label>
                    <input name="startDate" type="date" class="form-control" required />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Đến ngày (Tối đa 02 năm)</label>
                    <input name="endDate" type="date" class="form-control" required />
                </div>
            </div>
            <small class="text-muted mt-2 d-block">Lưu ý: Thời hạn tạm trú tối đa là 02 năm theo quy định.</small>
        </div>

        <!-- Owner Info -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">5. Thông tin chủ nhà/Chủ hộ</h5>
            
            <div class="row g-3 mb-3">
                <div class="col-md-8">
                    <label class="form-label">Nhập số CCCD chủ nhà để tra cứu</label>
                    <div class="input-group">
                        <input type="text" id="ownerCCCDLookup" class="form-control" placeholder="012345678901" />
                        <button type="button" class="btn btn-outline-primary" onclick="lookupOwner()">
                            <i class="bi bi-search"></i> Tra cứu
                        </button>
                    </div>
                </div>
            </div>

            <div id="lookupResult" class="mb-3" style="display:none;"></div>

            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Họ tên chủ nhà</label>
                    <input name="ownerName" id="ownerName" class="form-control" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Số CCCD</label>
                    <input name="ownerCCCD" id="ownerCCCD" class="form-control" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Số điện thoại</label>
                    <input name="ownerPhone" type="tel" class="form-control" placeholder="0912345678" required />
                </div>
            </div>
        </div>

        <!-- File Uploads -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">6. Hồ sơ đính kèm</h5>
            <p class="small text-muted mb-3">
                Tải lên: Hợp đồng thuê nhà, Giấy tờ chứng minh quyền sở hữu, Văn bản đồng ý của chủ hộ
            </p>
            <input type="file" name="files" multiple class="form-control" accept=".pdf,.jpg,.jpeg,.png" />
        </div>

        <!-- PIN Confirmation -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">7. Xác nhận</h5>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="confirmCheck" required />
                <label class="form-check-label" for="confirmCheck">
                    Tôi xác nhận thông tin khai báo là đúng sự thật và chịu trách nhiệm trước pháp luật.
                </label>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Nhập mã PIN xác nhận</label>
                    <input name="pin" type="password" class="form-control" placeholder="Mã PIN" required minlength="4" />
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-5">
            <a asp-controller="Citizen" asp-action="Applications" class="btn btn-link text-muted">Hủy bỏ</a>
            <button type="submit" class="btn btn-primary btn-lg px-5">
                <i class="bi bi-send"></i> Nộp hồ sơ
            </button>
        </div>
    </form>
</div>

<style>
    .max-width-900 { max-width: 900px; }
    .check-pass { color: #198754; }
    .check-fail { color: #dc3545; }
</style>

@section Scripts {
<script>
    async function lookupOwner() {
        const cccd = document.getElementById('ownerCCCDLookup').value;
        if (!cccd) {
            alert('Vui lòng nhập số CCCD chủ nhà');
            return;
        }

        const formData = new FormData();
        formData.append('cccd', cccd);

        const response = await fetch('@Url.Action("LookupOwner")', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        const resultDiv = document.getElementById('lookupResult');
        resultDiv.style.display = 'block';

        if (result.found && result.hasAccount) {
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + result.message;
            document.getElementById('ownerName').value = result.fullName || '';
            document.getElementById('ownerCCCD').value = result.cccd || '';
        } else {
            resultDiv.className = 'alert alert-warning';
            resultDiv.innerHTML = '<i class="bi bi-exclamation-circle"></i> ' + result.message;
            document.getElementById('ownerCCCD').value = cccd;
        }
    }

    async function verifyEligibility() {
        const cccd = document.getElementById('applicantCCCD').value;
        if (!cccd) {
            alert('Vui lòng nhập số CCCD');
            return;
        }

        const formData = new FormData();
        formData.append('applicantCCCD', cccd);

        const response = await fetch('@Url.Action("VerifyEligibility")', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        const resultsDiv = document.getElementById('verificationResults');
        resultsDiv.style.display = 'block';

        let html = '<div class="list-group list-group-flush">';
        for (const r of result.results) {
            const icon = r.passed ? '<i class="bi bi-check-circle-fill check-pass"></i>' : '<i class="bi bi-x-circle-fill check-fail"></i>';
            const bgClass = r.passed ? '' : 'list-group-item-danger';
            html += `<div class="list-group-item ${bgClass} d-flex justify-content-between align-items-center py-2">
                <div>${icon} <strong>${r.check}</strong></div>
                <div class="text-end small">${r.message}</div>
            </div>`;
        }
        html += '</div>';

        if (result.allPassed) {
            html = '<div class="alert alert-success mb-2 py-2"><i class="bi bi-shield-fill-check"></i> Đạt điều kiện đăng ký tạm trú</div>' + html;
        } else {
            html = '<div class="alert alert-warning mb-2 py-2"><i class="bi bi-shield-fill-x"></i> Có điều kiện cần xem xét</div>' + html;
        }

        resultsDiv.innerHTML = html;
    }
</script>
}
