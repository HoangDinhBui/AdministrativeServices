@{
    ViewData["Title"] = "Đăng ký kết hôn";
}

<div class="max-width-900 mx-auto">
    <div class="mb-4">
        <h2 class="fw-bold">Đăng ký kết hôn</h2>
        <p class="text-muted">Điền thông tin để đăng ký kết hôn. Hệ thống sẽ tự động kiểm tra điều kiện kết hôn.</p>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Create" method="post" enctype="multipart/form-data" id="marriageForm">
        <input type="hidden" name="serviceTypeId" value="@ViewBag.ServiceId" />

        <!-- Applicant Info -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">1. Thông tin người nộp hồ sơ</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Họ và tên</label>
                    <input name="applicantName" id="applicantName" class="form-control" value="@ViewBag.ApplicantName" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Số CCCD</label>
                    <input name="applicantCCCD" id="applicantCCCD" class="form-control" value="@ViewBag.ApplicantCCCD" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Giới tính</label>
                    <select name="applicantGender" id="applicantGender" class="form-select" required>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Ngày sinh</label>
                    <input name="applicantDOB" id="applicantDOB" type="date" class="form-control" required />
                </div>
                <div class="col-md-8">
                    <label class="form-label">Địa chỉ thường trú</label>
                    <input name="applicantAddress" id="applicantAddress" class="form-control" required />
                </div>
            </div>
        </div>

        <!-- Spouse Lookup -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">2. Thông tin người kết hôn (Vợ/Chồng)</h5>
            
            <div class="row g-3 mb-3">
                <div class="col-md-8">
                    <label class="form-label">Nhập số CCCD để tra cứu tự động</label>
                    <div class="input-group">
                        <input type="text" id="spouseCCCDLookup" class="form-control" placeholder="012345678901" />
                        <button type="button" class="btn btn-outline-primary" onclick="lookupSpouse()">
                            <i class="bi bi-search"></i> Tra cứu
                        </button>
                    </div>
                </div>
            </div>

            <div id="lookupResult" class="mb-3" style="display:none;"></div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Họ và tên</label>
                    <input name="spouseName" id="spouseName" class="form-control" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Số CCCD</label>
                    <input name="spouseCCCD" id="spouseCCCD" class="form-control" required />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Giới tính</label>
                    <select name="spouseGender" id="spouseGender" class="form-select" required>
                        <option value="Nữ">Nữ</option>
                        <option value="Nam">Nam</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Ngày sinh</label>
                    <input name="spouseDOB" id="spouseDOB" type="date" class="form-control" required />
                </div>
                <div class="col-md-8">
                    <label class="form-label">Địa chỉ thường trú</label>
                    <input name="spouseAddress" id="spouseAddress" class="form-control" required />
                </div>
            </div>
        </div>

        <!-- Auto Verification -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">3. Kiểm tra điều kiện kết hôn</h5>
            <p class="small text-muted mb-3">Bấm nút bên dưới để hệ thống tự động kiểm tra các điều kiện kết hôn.</p>
            
            <button type="button" class="btn btn-info mb-3" onclick="verifyEligibility()">
                <i class="bi bi-shield-check"></i> Kiểm tra điều kiện
            </button>

            <div id="verificationResults" style="display:none;"></div>
        </div>

        <!-- File Uploads -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">4. Hồ sơ đính kèm</h5>
            <p class="small text-muted mb-3">
                Tải lên: Ảnh chân dung 2 người, Giấy xác nhận tình trạng hôn nhân (nếu cần)
            </p>
            <input type="file" name="files" multiple class="form-control" accept=".pdf,.jpg,.jpeg,.png" />
        </div>

        <!-- PIN Confirmation -->
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3 border-bottom pb-2">5. Xác nhận cam đoan</h5>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="confirmCheck" required />
                <label class="form-check-label" for="confirmCheck">
                    Tôi cam đoan các thông tin khai báo trên là đúng sự thật và chịu trách nhiệm trước pháp luật.
                </label>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Nhập mã PIN xác nhận</label>
                    <input name="pin" type="password" class="form-control" placeholder="Nhập mã PIN" required minlength="4" />
                </div>
            </div>
        </div>

        <!-- Fee Info -->
        <div class="glass-card p-4 mb-4 bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="fw-bold mb-1">Lệ phí đăng ký kết hôn</h6>
                    <small class="text-muted">Thanh toán khi nhận kết quả</small>
                </div>
                <div class="fs-4 fw-bold text-primary">@ViewBag.Fee?.ToString("N0") VNĐ</div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-5">
            <a asp-controller="Citizen" asp-action="Applications" class="btn btn-link text-muted">Hủy bỏ</a>
            <button type="submit" class="btn btn-primary btn-lg px-5">
                <i class="bi bi-send"></i> Nộp hồ sơ
            </button>
        </div>
    </form>
</div>

<style>
    .max-width-900 { max-width: 900px; }
    .check-pass { color: #198754; }
    .check-fail { color: #dc3545; }
</style>

@section Scripts {
<script>
    async function lookupSpouse() {
        const cccd = document.getElementById('spouseCCCDLookup').value;
        if (!cccd) {
            alert('Vui lòng nhập số CCCD');
            return;
        }

        const formData = new FormData();
        formData.append('cccd', cccd);

        const response = await fetch('@Url.Action("LookupSpouse")', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        const resultDiv = document.getElementById('lookupResult');
        resultDiv.style.display = 'block';

        if (result.found) {
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + result.message;

            // Auto-fill fields
            document.getElementById('spouseName').value = result.fullName || '';
            document.getElementById('spouseCCCD').value = result.cccd || '';
            document.getElementById('spouseAddress').value = result.address || '';
            if (result.dateOfBirth) {
                document.getElementById('spouseDOB').value = result.dateOfBirth;
            }
            if (result.gender) {
                document.getElementById('spouseGender').value = result.gender;
            }
        } else {
            resultDiv.className = 'alert alert-warning';
            resultDiv.innerHTML = '<i class="bi bi-exclamation-circle"></i> ' + result.message;
        }
    }

    async function verifyEligibility() {
        const formData = new FormData();
        formData.append('applicantCCCD', document.getElementById('applicantCCCD').value);
        formData.append('spouseCCCD', document.getElementById('spouseCCCD').value);
        formData.append('applicantGender', document.getElementById('applicantGender').value);
        formData.append('spouseGender', document.getElementById('spouseGender').value);
        formData.append('applicantDOB', document.getElementById('applicantDOB').value);
        formData.append('spouseDOB', document.getElementById('spouseDOB').value);

        // Validate required fields
        if (!formData.get('applicantDOB') || !formData.get('spouseDOB')) {
            alert('Vui lòng điền đầy đủ ngày sinh của cả hai người');
            return;
        }

        const response = await fetch('@Url.Action("VerifyEligibility")', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        const resultsDiv = document.getElementById('verificationResults');
        resultsDiv.style.display = 'block';

        let html = '<div class="list-group">';
        for (const r of result.results) {
            const icon = r.passed ? '<i class="bi bi-check-circle-fill check-pass"></i>' : '<i class="bi bi-x-circle-fill check-fail"></i>';
            const bgClass = r.passed ? '' : 'list-group-item-danger';
            html += `<div class="list-group-item ${bgClass} d-flex justify-content-between align-items-center">
                <div>${icon} <strong>${r.check}</strong></div>
                <div class="text-end small">${r.message}</div>
            </div>`;
        }
        html += '</div>';

        if (result.allPassed) {
            html = '<div class="alert alert-success mb-3"><i class="bi bi-shield-fill-check"></i> Kiểm tra tự động: <strong>Đạt tất cả điều kiện</strong></div>' + html;
        } else {
            html = '<div class="alert alert-danger mb-3"><i class="bi bi-shield-fill-x"></i> Kiểm tra tự động: <strong>Có điều kiện không đạt</strong>. Cán bộ sẽ xem xét thêm.</div>' + html;
        }

        resultsDiv.innerHTML = html;
    }
</script>
}
