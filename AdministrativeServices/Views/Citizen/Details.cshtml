@model AdministrativeServices.Models.Application
@using System.Text.Json

@{
    ViewData["Title"] = "Chi tiết hồ sơ #" + Model.Id.ToString("D5");
    JsonElement? formData = null;
    try { formData = JsonSerializer.Deserialize<JsonElement>(Model.ContentJson); } catch { }
}

<div class="mb-4">
    <a asp-action="Applications" class="btn btn-link text-muted px-0"><i class="bi bi-arrow-left"></i> Quay lại danh sách</a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <h4 class="fw-bold mb-0">Hồ sơ #@Model.Id.ToString("D5")</h4>
                @{
                    var badgeClass = Model.Status switch
                    {
                        ApplicationStatus.Submitted => "bg-primary",
                        ApplicationStatus.InReview => "bg-info",
                        ApplicationStatus.PendingApproval => "bg-warning",
                        ApplicationStatus.Signed => "bg-info",
                        ApplicationStatus.Completed => "bg-success",
                        ApplicationStatus.Rejected => "bg-danger",
                        ApplicationStatus.SupplementRequired => "bg-warning text-dark",
                        _ => "bg-secondary"
                    };
                    var statusText = Model.Status switch
                    {
                        ApplicationStatus.Submitted => "Đã nộp",
                        ApplicationStatus.InReview => "Đang thẩm định",
                        ApplicationStatus.PendingApproval => "Chờ ký duyệt",
                        ApplicationStatus.Signed => "Đã ký",
                        ApplicationStatus.Completed => "Hoàn thành",
                        ApplicationStatus.Rejected => "Bị từ chối",
                        ApplicationStatus.SupplementRequired => "Cần bổ sung",
                        _ => Model.Status.ToString()
                    };
                }
                <span class="badge @badgeClass fs-6">@statusText</span>
            </div>
            
            <dl class="row">
                <dt class="col-sm-4 text-muted">Dịch vụ:</dt>
                <dd class="col-sm-8 fw-bold">@Model.ServiceType?.Name</dd>

                <dt class="col-sm-4 text-muted">Ngày nộp:</dt>
                <dd class="col-sm-8">@Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")</dd>

                <dt class="col-sm-4 text-muted">Cập nhật lần cuối:</dt>
                <dd class="col-sm-8">@Model.LastModifiedDate?.ToString("dd/MM/yyyy HH:mm")</dd>
            </dl>

            @if (!string.IsNullOrEmpty(Model.RejectReason))
            {
                <div class="alert alert-danger mt-3">
                    <strong>Lý do từ chối:</strong> @Model.RejectReason
                </div>
            }

            @if (!string.IsNullOrEmpty(Model.SupplementNote))
            {
                <div class="alert alert-warning mt-3">
                    <strong>Yêu cầu bổ sung:</strong> @Model.SupplementNote
                </div>
            }
        </div>

        @if (formData.HasValue)
        {
            <div class="glass-card p-4 mb-4">
                <h5 class="fw-bold mb-3">Nội dung hồ sơ</h5>
                <div class="row g-3">
                    @foreach (var prop in formData.Value.EnumerateObject())
                    {
                        <div class="col-md-6">
                            <label class="small text-muted">@prop.Name:</label>
                            <div class="fw-medium">@prop.Value.ToString()</div>
                        </div>
                    }
                </div>
            </div>
        }

        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3">Tệp tin đính kèm</h5>
            @if (Model.Attachments.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var file in Model.Attachments)
                    {
                        <a href="@file.FilePath" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-file-earmark me-2"></i>@file.FileName</span>
                            <span class="btn btn-sm btn-outline-primary">Xem</span>
                        </a>
                    }
                </div>
            }
            else
            {
                <p class="text-muted mb-0">Không có tệp đính kèm.</p>
            }
        </div>

        <div class="glass-card p-4">
            <h5 class="fw-bold mb-3">Lịch sử xử lý</h5>
            @if (Model.History.Any())
            {
                <div class="timeline">
                    @foreach (var log in Model.History.OrderByDescending(h => h.ChangeDate))
                    {
                        <div class="border-start border-3 border-primary ps-3 pb-3">
                            <div class="fw-bold">@log.Status</div>
                            <div class="text-muted small">@log.ChangeDate.ToString("dd/MM/yyyy HH:mm") - @log.ChangedBy?.FullName</div>
                            <p class="mb-0 mt-1 fst-italic">"@log.Note"</p>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted mb-0">Chưa có lịch sử xử lý.</p>
            }
        </div>
    </div>

    <div class="col-lg-4">
        <div class="glass-card p-4 sticky-top" style="top: 1rem;">
            <h5 class="fw-bold mb-3">Thông tin liên hệ</h5>
            <p class="small text-muted mb-3">Nếu cần hỗ trợ, vui lòng liên hệ:</p>
            <p class="mb-2"><i class="bi bi-telephone me-2"></i> 1900.xxxx</p>
            <p class="mb-0"><i class="bi bi-envelope me-2"></i> support@dichvucong.gov.vn</p>
        </div>
    </div>
</div>
